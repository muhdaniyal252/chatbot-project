{% extends 'core/base.html' %}
{% block title %}Chat App{% endblock %}
{% block content %}
<div class="container">
    <div class="sidebar" id="sidebar" style="display:none;">
        <div class="sidebar-section">
            <h3 style="display:flex;align-items:center;justify-content:space-between;">
                <span>Agents</span>
                <a href="{% url 'create_agent' %}" title="Add Agent" style="color:#333;font-size:1.3em;text-decoration:none;padding:0 0.2em;">&#43;</a>
            </h3>
            <ul class="agent-list" id="agent-list"></ul>
        </div>
        <div class="sidebar-section">
            <h3 style="display:flex;align-items:center;justify-content:space-between;">
                <span>Chats</span>
                <button id="add-chat-btn" title="Add Chat" style="background:none;border:none;color:#333;font-size:1.3em;cursor:pointer;padding:0 0.2em;">&#43;</button>
            </h3>
            <ul class="chat-list" id="chat-list"></ul>
        </div>

        <!-- Modal for creating chat -->
        <div id="chat-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0005;z-index:1000;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:2em;border-radius:10px;min-width:300px;max-width:90vw;box-shadow:0 2px 12px #0002;">
                <h3 style="margin-top:0;">Create Chat</h3>
                <form id="create-chat-form" style="display:flex;flex-direction:column;gap:1em;">
                    <label for="agent-select">Select Agent:</label>
                    <select id="agent-select" name="agent" required style="padding:0.7em;border:1px solid #ccc;border-radius:5px;"></select>
                    <label for="chat-title">Chat Title:</label>
                    <input type="text" id="chat-title" name="title" required style="padding:0.7em;border:1px solid #ccc;border-radius:5px;">
                    <div style="display:flex;gap:1em;justify-content:flex-end;">
                        <button type="button" id="cancel-chat-btn" style="padding:0.5em 1.2em;background:#eee;border:none;border-radius:5px;">Cancel</button>
                        <button type="submit" style="padding:0.5em 1.2em;background:#333;color:#fff;border:none;border-radius:5px;font-weight:bold;">Create</button>
                    </div>
                </form>
                <div id="chat-modal-result" style="margin-top:1em;text-align:center;"></div>
            </div>
        </div>
    </div>
    <div class="main">
        <h2>Welcome to the Chat App</h2>
        <div id="chat-content"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get user ID from JWT access token
    function parseJwt (token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
            return {};
        }
    }

    let USER_ID = null;
    const accessToken = localStorage.getItem('access');
    if (accessToken) {
        const payload = parseJwt(accessToken);
        USER_ID = payload.user_id || payload.id || null;
    }

    let agentsCache = [];

    // Sidebar rendering
    function renderSidebar() {
        const sidebar = document.getElementById('sidebar');
        if (isLoggedIn()) {
            sidebar.style.display = 'flex';
            fetchAgents();
            fetchChats();
        } else {
            sidebar.style.display = 'none';
        }
    }

    // Fetch agents
    async function fetchAgents() {
        const agentList = document.getElementById('agent-list');
        const token = localStorage.getItem('access');
        if (!token) {
            agentList.innerHTML = '';
            return;
        }
        const response = await fetch("{% url 'user_agents' %}", {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await response.json();
        agentsCache = data.agents || [];
        if (agentsCache.length) {
            agentList.innerHTML = agentsCache.map(a =>
                `<li style="display:flex;align-items:center;justify-content:space-between;">
                    <span>${a.name}</span>
                    <a href="/agents/update/${a.id}/" title="Edit Agent" style="color:#333;font-size:1.1em;text-decoration:none;padding-left:0.5em;">
                        <span style="display:inline-block;vertical-align:middle;">&#9998;</span>
                    </a>
                </li>`
            ).join('');
        } else {
            agentList.innerHTML = '<li style="color:#888;">No agents</li>';
        }
    }

    // Fetch chats
    async function fetchChats() {
        const chatList = document.getElementById('chat-list');
        const token = localStorage.getItem('access');
        if (!token) {
            chatList.innerHTML = '';
            return;
        }
        const response = await fetch("{% url 'user_chats' %}", {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await response.json();
        if (data.chats && data.chats.length) {
            chatList.innerHTML = data.chats.map(c =>
                `<li style="cursor:pointer;" onclick="openChat(${c.id}, '${c.title.replace(/'/g, "&#39;")}', '${c.agent__name.replace(/'/g, "&#39;")}' )">
                    <span>${c.title}</span> <span style='color:#888;font-size:0.9em;'>(${c.agent__name})</span>
                </li>`
            ).join('');
        } else {
            chatList.innerHTML = '<li style="color:#888;">No chats</li>';
        }
    }

    // Open chat and fetch messages
    async function openChat(chatId, chatTitle, agentName) {
        const token = localStorage.getItem('access');
        const response = await fetch(`/api/chats/${chatId}/messages/`, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await response.json();
        showChatInterface(chatId, chatTitle, null, data.messages || [], agentName);
    }

    // Unified Chat Interface function (previous messages + WebSocket + user/AI distinction)
    function showChatInterface(chatId, chatTitle, agentId, messages = [], agentName = '') {
        const main = document.querySelector('.main');

        main.innerHTML = `
            <h2>Chat: ${chatTitle} <span style='color:#888;font-size:0.8em;'>(${agentName || ''})</span></h2>
            <div id="chat-messages" style="height:300px;overflow-y:auto;border:1px solid #ccc;border-radius:5px;padding:1em;background:#fafafa;margin-bottom:1em;"></div>
            <form id="send-message-form" style="display:flex;gap:0.5em;">
                <input type="text" id="message-input" placeholder="Type a message..." style="flex:1;padding:0.7em;border:1px solid #ccc;border-radius:5px;">
                <button type="submit" id="send-btn" style="padding:0.7em 1.2em;background:#333;color:#fff;border:none;border-radius:5px;font-weight:bold;display:flex;align-items:center;justify-content:center;">
                    <span style="font-size:1.3em;" title="Send">&#10148;</span>
                </button>
                <button type="button" id="mic-btn" style="padding:0.7em 1.2em;background:#007BFF;color:#fff;border:none;border-radius:5px;font-weight:bold;display:flex;align-items:center;justify-content:center;">
                    <span id="mic-icon" style="font-size:1.3em;" title="Record">&#127908;</span>
                </button>
            </form>
        `;

        const chatMessages = document.getElementById('chat-messages');

        // Render previous messages (markdown)
        if (messages.length) {
            chatMessages.innerHTML = messages.map(m => {
                const sender = m.by === 'ai' ? 'AI' : m.user;
                const color = m.by === 'ai' ? '#007BFF' : '#333';
                const align = m.by === 'ai' ? 'flex-start' : 'flex-end';
                // If message has audio_url or synthesized_audio_url, render above text
                let audioHtml = '';
                if (m.audio_url) {
                    audioHtml += `<div style="margin-bottom:0.3em;"><audio controls src="${m.audio_url}" style="width:100%;"></audio></div>`;
                }
                if (m.synthesized_audio_url) {
                    audioHtml += `<div style="margin-bottom:0.3em;"><audio controls src="${m.synthesized_audio_url}" style="width:100%;"></audio></div>`;
                }
                return `
                    <div style="display:flex;justify-content:${align};margin-bottom:0.5em;">
                        <div style="background:${m.by === 'ai' ? '#e1f0ff' : '#dcdcdc'};padding:0.5em 0.8em;border-radius:8px;max-width:70%;">
                            ${audioHtml}
                            <div class="markdown-text">${window.marked ? marked.parse(m.content) : m.content}</div>
                            <div style="font-size:0.7em;color:#888;text-align:right;">${m.timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            chatMessages.innerHTML = '<div style="color:#888;">No messages yet.</div>';
        }

        // Load marked.js for markdown rendering
        if (!window.marked) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            script.onload = () => {
                document.querySelectorAll('.markdown-text').forEach(el => {
                    el.innerHTML = window.marked.parse(el.textContent);
                });
            };
            document.head.appendChild(script);
        }
        let ws = null;

        document.getElementById('send-message-form').onsubmit = async function(e) {
            e.preventDefault();
            const message = document.getElementById('message-input').value;
            if (!message) return;
            const userId = USER_ID;
            // Initialize WebSocket if not connected
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                ws = new WebSocket('ws://localhost:8001/send-message');
                ws.onopen = function() {
                    ws.send(JSON.stringify({ message, chatid: chatId, userid: userId }));
                };
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.status === 'success' && data.result) {
                        const chatMessages = document.getElementById('chat-messages');
                        chatMessages.innerHTML += `
                            <div style="display:flex;justify-content:flex-start;margin-bottom:0.5em;">
                                <div style="background:#e1f0ff;padding:0.5em 0.8em;border-radius:8px;max-width:70%;">
                                    <div class="markdown-text">${window.marked ? marked.parse(data.result) : data.result}</div>
                                    <div style="font-size:0.7em;color:#888;text-align:right;">${new Date().toLocaleTimeString()}</div>
                                </div>
                            </div>
                        `;
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                };
                ws.onerror = function(err) {
                    console.error('WebSocket error:', err);
                };
                ws.onclose = function() {
                    console.log('WebSocket closed.');
                };
            } else {
                ws.send(JSON.stringify({ message, chatid: chatId, userid: userId }));
            }
            // Append user's message immediately
            chatMessages.innerHTML += `
                <div style="display:flex;justify-content:flex-end;margin-bottom:0.5em;">
                    <div style="background:#dcdcdc;padding:0.5em 0.8em;border-radius:8px;max-width:70%;">
                        <div class="markdown-text">${window.marked ? marked.parse(message) : message}</div>
                        <div style="font-size:0.7em;color:#888;text-align:right;">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            document.getElementById('message-input').value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        // Audio recording and sending logic
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        micBtn.onclick = async function() {
            if (!isRecording) {
                // Start recording
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Audio recording not supported.');
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    let mimeType = '';
                    if (MediaRecorder.isTypeSupported('audio/webm')) {
                        mimeType = 'audio/webm';
                    } else if (MediaRecorder.isTypeSupported('audio/wav')) {
                        mimeType = 'audio/wav';
                    } else {
                        mimeType = '';
                    }
                    mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => {
                        if (e.data.size > 0) audioChunks.push(e.data);
                    };
                    mediaRecorder.onstop = async () => {
                        // Prefer wav, else webm
                        let audioBlob;
                        if (mimeType === 'audio/wav') {
                            audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        } else {
                            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        }
                        const recordedAudioUrl = URL.createObjectURL(audioBlob);
                        // Send audio to FastAPI websocket endpoint
                        const userId = USER_ID;
                        const wsAudio = new WebSocket('ws://localhost:8001/send-audio-message');
                        wsAudio.binaryType = 'arraybuffer';
                        wsAudio.onopen = function() {
                            wsAudio.send(JSON.stringify({ chatid: chatId, userid: userId }));
                            audioBlob.arrayBuffer().then(buffer => {
                                wsAudio.send(buffer);
                            });
                        };
                        let transcription = '';
                        let llm_response = '';
                        let synthesizedAudioUrl = '';
                        wsAudio.onmessage = function(event) {
                            if (typeof event.data === 'string') {
                                const data = JSON.parse(event.data);
                                if (data.status === 'success') {
                                    transcription = data.transcription;
                                    llm_response = data.llm_response;
                                    // Wait for synthesized audio before rendering
                                }
                            } else {
                                // Second message: audio bytes
                                const audioBlobSynth = new Blob([event.data], { type: 'audio/mp3' });
                                synthesizedAudioUrl = URL.createObjectURL(audioBlobSynth);
                                // Render both audios above their respective texts in chat
                                const chatMessages = document.getElementById('chat-messages');
                                chatMessages.innerHTML += `
                                    <div style="display:flex;justify-content:flex-end;margin-bottom:0.5em;">
                                        <div style="background:#dcdcdc;padding:0.5em 0.8em;border-radius:8px;max-width:70%;">
                                            <audio controls src="${recordedAudioUrl}" style="width:100%;margin-bottom:0.3em;"></audio>
                                            <div class="markdown-text">${window.marked ? marked.parse(transcription) : transcription}</div>
                                            <div style="font-size:0.7em;color:#888;text-align:right;">${new Date().toLocaleTimeString()}</div>
                                        </div>
                                    </div>
                                    <div style="display:flex;justify-content:flex-start;margin-bottom:0.5em;">
                                        <div style="background:#e1f0ff;padding:0.5em 0.8em;border-radius:8px;max-width:70%;">
                                            <audio controls src="${synthesizedAudioUrl}" style="width:100%;margin-bottom:0.3em;"></audio>
                                            <div class="markdown-text">${window.marked ? marked.parse(llm_response) : llm_response}</div>
                                            <div style="font-size:0.7em;color:#888;text-align:right;">${new Date().toLocaleTimeString()}</div>
                                        </div>
                                    </div>
                                `;
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        };
                        wsAudio.onerror = function(err) {
                            console.error('WebSocket audio error:', err);
                        };
                        wsAudio.onclose = function() {
                            console.log('WebSocket audio closed.');
                        };
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    micIcon.innerHTML = '&#9632;'; // Stop icon
                } catch (err) {
                    alert('Could not start audio recording: ' + err);
                }
            } else {
                // Stop recording
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                isRecording = false;
                micIcon.innerHTML = '&#127908;'; // Mic icon
            }
        };
    }

    // Modal logic for chat creation
    function openChatModal() {
        const modal = document.getElementById('chat-modal');
        const agentSelect = document.getElementById('agent-select');
        agentSelect.innerHTML = agentsCache.length ? agentsCache.map(a => `<option value="${a.id}">${a.name}</option>`).join('') : '<option disabled>No agents</option>';
        document.getElementById('chat-title').value = '';
        document.getElementById('chat-modal-result').innerText = '';
        modal.style.display = 'flex';
    }

    function closeChatModal() {
        document.getElementById('chat-modal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderSidebar();
        document.getElementById('add-chat-btn').onclick = openChatModal;
        document.getElementById('cancel-chat-btn').onclick = closeChatModal;
        document.getElementById('create-chat-form').onsubmit = async function(e) {
            e.preventDefault();
            const agentId = document.getElementById('agent-select').value;
            const title = document.getElementById('chat-title').value;
            const token = localStorage.getItem('access');
            const resultDiv = document.getElementById('chat-modal-result');
            if (!agentId || !title) {
                resultDiv.innerText = 'Please select an agent and enter a title.';
                return;
            }
            const response = await fetch("{% url 'create_chat' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? 'Bearer ' + token : ''
                },
                body: JSON.stringify({ agent: agentId, title })
            });
            const data = await response.json();
            if (response.ok && data.id) {
                closeChatModal();
                showChatInterface(data.id, title, agentId);
                fetchChats();
            } else {
                resultDiv.innerText = data.error || 'Failed to create chat.';
            }
        };
    });
</script>
{% endblock %}
